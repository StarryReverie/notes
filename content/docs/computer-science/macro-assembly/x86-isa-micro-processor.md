---
title: x86 架构微处理器
weight: 100
math: false
---

- **微处理器基本结构**
    - **重要结构**
        - 总线接口单元（BIU）：包括数据、控制、指令总线，连接各个组件，用于传递信息。
        - 中央处理单元（CPU）：包括指令读取、指令译码、执行单元等。
        - 内存管理单元（MMU）：包括分段和分页组件，负责内存管理和保护、地址转换等。
    - **工作模式**
        - 实模式：CPU 复位后的默认模式，字长只到 16 位，任何代码都具有完全权限。
        - 保护模式：从实模式提示后的模式，字长到达 32 位，支持高级功能，划分特权级。
        - 虚拟 8086 模式：保护模式下模拟实模式，具有一定兼容性，但权限受限，特权指令需要模拟。
- **寄存器**
    - **通用寄存器**
        - `EAX`：累加器，主要用于算术运算和数据传输。
        - `EBX`：保存数据，常用于基址寄存器，即作为一段连续内存区域的起始地址。
        - `ECX`: 保存数据，常用于循环计数器。
        - `EDX`：保存数据，在使用乘除法指令时保存数据的专用区域。
        - `EBP`：保存栈帧基址，启用 FPO 后，无特殊职责，可以用于其他用途。
        - `EDI`：常用于目的操作数索引。
        - `ESI`：常用于源操作数索引。
        - `ESP`：固定用于保存栈顶地址。
    - **段寄存器**
        - `CS`：代码段寄存器。
        - `DS`：数据段寄存器。
        - `SS`：堆栈段寄存器。
        - `ES`：附加数据/扩展段寄存器。
        - `FS`、`GS`：无明显的命名含义，常用于线程局部存储。
        - 所有的段寄存器都是 16 位。
        - 实模式下，段寄存器保存段基址的高 16 位。
        - 保护模式下，段寄存器保存段选择符，间接表示段基址。
    - **标志寄存器**
        - `CF`、`ZF`、`SF`、`OF` 参考[计算机系统部分的介绍](/docs/computer-science/computer-system/machine-level-programming#vkqifa)。
        - `PF`：即 Parity Flag，若运行结果的最低 8 位为 `res8`，则 `PF == popcount(res8) % 2`。
        - `AF`：即 Auxiliary Carry Flag，若运行结果的最低 4 位向次低 4 位进位或借位，则为 `1`。
        - `TF`：即 Trap Enable Flag，为 `1` 时每条指令执行后产生中断，用于单步调试。
        - `IF`：即 Interrupt Enable Flag，为 `1` 时允许接收中断。
        - `DF`：即 Direction Flag，为 `0` 时串操作地址自动递增，为 `1` 时自动递减。
        - `IOPL`：表示 IO 操作的所需最低特权级，取值 `0` 到 `3`。
        - `NT`：即 Nested Task Flag，仅保护模式可用，如果任务执行在另外一个任务中，则为 `1`。
        - `VM`：为 `1` 时，处于虚拟 8086 模式。
    - **控制寄存器**
        - `CR0`：包括机器状态。
            - 第 0 位 `PE`：即 Protection Mode Enable，设置为 `1` 则进入保护模式。
            - 第 1 位 `MP`：即 Monitor Coprocessor Extension，若存在协处理器则为 `1`。
            - 第 2 位 `EM`：即 Emulate Processor Extension，为 `1` 时使用软件运算，为 `0` 用硬件协处理器运算。
            - 第 3 位 `TS`：即 Task Switched，任务切换后被设为 `1`。
            - 第 4 位 `ET`：即 Extension Type，协处理器选择标志，80386 以后，为 `1` 表示系统中存在协处理器。
            - 第 31 位 `PG`：即 Paging Enable，为 `1` 时启用分页内存管理。
        - `CR1`：保留，暂无意义。
        - `CR2`：页面故障线性地址寄存器，发生缺页中断时，保存要访问的虚拟地址。
        - `CR3`：页目录基址寄存器（PDBR），保存页目录表首地址，必须按页大小 4KiB 对齐（低 12 位为 `0`）。
        - 所有控制寄存器都为 32 位。
    - **描述符表寄存器**
        - 限长：长度减 1，地址偏移量或索引的合法区间。
        - `GDTR`：全局描述符表寄存器，表示全局描述符表（GDT）的位置，高 32 位记录基址，低 16 位记录内存大小限长。
        - `IDTR`：中断描述符表寄存器，表示中断描述符表（IDT）的位置，高 32 位记录基址，低 16 位记录内存大小限长。
        - `LDTR`：局部描述符表寄存器，16 位，保存 GDT 的选择符，对应局部描述符表（LDT）在 GDT 中的表项。
    - **任务管理寄存器**
        - `TR`：16 位，保存 GDT 的选择符，对应 TSS 描述符在 GDT 中的表项。表示当前任务的上下文保存位置。
- **内存管理**
    - **实模式段式管理**
        - 实模式下地址空间 20 位，但是 20 位地址无法直接表示，需要用段寄存器保存高 16 位。
        - 段的最大长度为 64 KiB（16 位）。
        - 地址用 `base:offset` 来指定，被转换为 `base * 16 + offset`。
        - 没有任何保护机制。
    - **保护模式段式管理**
        - **段选择符**
            - 段寄存器在保护模式下保存段选择符，不直接保存段基址。
            - 段选择符共 16 位，包括：
                - 第 15~3 位：表示 GDT 中的索引。
                - 第 2 位 `TI`：即 Table Indicator，表示用于在 GDT（`TI` 为 `0`）或 LDT 中查询。
                - 第 1~0 位 `RPL`：即 Requested Privilege Level。
        - **段描述符**
