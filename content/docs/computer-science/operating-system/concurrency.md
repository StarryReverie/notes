---
title: 并发
weight: 400
math: true
---

- **并发进程的特点**
    - **分类**
        - 互斥关系：对资源共享引起，是间接制约关系。
        - 同步关系：协作完成同一个任务、需要互相等待同步引起，是直接制约关系。
        - 前序关系：由互斥、同步关系引起，决定各个进程的创建和终止时间。
    - **顺序**
        - 间接制约关系的进程可以并发，但是可能会互斥执行。
        - 直接制约关系的进程要顺序执行。
- **互斥**
    - **临界区**
        - 临界资源：一次只允许一个进程访问的共享资源。
        - 临界区：访问临界资源的必须互斥执行的程序。
    - **进入临界区的准则**
        - 互斥使用：不能有两个或以上的进程在临界区执行。
        - 让权等待：等待进入的进程，要释放 CPU 并阻塞等待。
        - 有空让进：在临界区外的进程不可以阻止其他进程进入临界区。
        - 有限等待：等待过程不可以无限长。
    - **软件实现**
        - 实现复杂，不够灵活。
    - **硬件实现**
        - 关中断：简单、限制了并发能力、使进程权限过高、对多 CPU 无效。
        - 硬件指令：原子变量 CAS，实现自旋锁，会浪费 CPU 时间。
    - **信号量**
        - 信号量可以完成互斥功能，并且可以使进程阻塞等待，不会浪费 CPU。
- **信号量**
    - **定义**
        - 信号量包含 `value` 和一个进程队列（指针）`processes`。
        - `value` 大于等于 $0$ 时表示可以资源数量，小于 $0$ 时表示等待进程数量。
    - **操作**
        - 信号量包含 P 操作（acquire）和 V 操作（release）。
        - P：表示获取资源。递减 `value`，如果递减后小于 $0$，则把当前进程加入队列。
        - V：表示释放资源。递增 `value`，如果队列中有进程，取出一个并唤醒。
        - P/V 操作是原语，不可中断。
    - **实现互斥锁**
        - 对于一个需要互斥保护的资源，定义一个信号量 `mutex`，初值为 $1$。
        - 访问资源时，使用 `P(mutex)`，不需要访问时，使用 `V(mutex)`。
        - `mutex.value` 的取值为 $(-\infty, 1]$。
    - **实现通道/同步队列/MPMC**
        - 对于一个长度为 $n$ 的通道，有三种资源：
            - 空位置：用 `empty` 表示，初值为 $n$（通道初始为空）。
            - 已写位置：用 `full` 表示，初值为 $0$。
            - 通道修改权限：用 `mutex` 表示，初值为 $1$。
        - Send/Produce：按顺序执行 `P(empty)`、`P(mutex)`、插入、`V(full)`、`V(mutex)`。
        - Receive/Consume：按顺序执行 `P(full)`、`P(mutex)`、删除、`V(empty)`、`V(mutex)`。
        - `mutex` 的使用：
            - 对于 $n > 1$，可能存在多个进程可以同时修改通道，需要用互斥锁。
            - 对于 $n = 1$，可以不需要 `mutex`，`empty` 和 `full` 之间的关系保证不会有竞争。
        - `P(empty)`/`P(full)` 和 `P(mutex)` 不可以交换，否则可能造成死锁。
    - **实现读写锁**
        - 使用以下数据：
            - 写权限：`wmutex` 信号量，初值为 $1$。
            - 修改读进程数权限：`rmutex` 信号量，初值为 $1$。
            - 读进程数：`count`，初值为 $0$。
        - 读：按顺序执行：
            - `P(rmutex)`。
            - 如果 `count` 等于 $0$，则 `P(wmutex)`，因为接下来开始有读操作，不可以写。
            - 递增 `count`。
            - `V(rmutex)`。
            - 读操作。
            - `P(rmutex)`
            - 递减 `count`。
            - 如果 `count` 等于 $0$，则 `V(wmutex)`，因为最后一个读操作已完成，接下来可以写。
            - `V(rmutex)`。
        - 写：按顺序执行：
            - `P(wmutex)`。
            - 写操作。
            - `V(wmutex)`。
- **高级通信**
    - **方式**
        - 消息缓冲
        - 信箱
        - 管道
        - 共享内存
- **死锁**
    - **必要条件**
        - 互斥条件：需要访问临界资源。
        - 保持和等待条件：进程请求其他资源而阻塞时，不释放已获得资源。
        - 不剥夺条件：已经分配给进程的资源只能由进程释放。
        - 循环等待：每个进程等待另外一个进程的资源，最终依赖于自身。
